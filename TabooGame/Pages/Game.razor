@inject NavigationManager navigationManager
@page "/"
@page "/Game"
@* LOGIN *@
<div class="wrapper">
    @if (_screens == Screens.LOGIN)
    {
        <div id="login">
            <input type="text" placeholder="Player Name" @bind="_player.Name">
            <input type="number" placeholder="Lobby ID" @bind="_lobbyID">
            <button @onclick="Play">PLAY</button>
        </div>
    }
    else if (_screens == Screens.LOBBY)
    {
        <div id="lobby">
            <button id="back-btn" @onclick="()=>_screens = Screens.LOGIN">GO TO BACK</button>
            <div id="lobby-settings">
                <fieldset>
                    <legend>Game Options</legend>
                    <div class="lobby-setting">
                        LOBBY ID @_lobby.ID
                    </div>
                    <div class="lobby-setting">
                        <span>Number of win</span>
                        <select>
                            <option>10</option>
                            <option selected>20</option>
                            <option>30</option>
                            <option>40</option>
                            <option>50</option>
                        </select>
                    </div>
                    <div class="lobby-setting">
                        <span>Remaining Pass</span>
                        <select>
                            <option>1</option>
                            <option>2</option>
                            <option selected>3</option>
                        </select>
                    </div>
                    <div class="lobby-setting">
                        <span>Remaining Taboo</span>
                        <select>
                            <option>1</option>
                            <option>2</option>
                            <option selected>3</option>
                        </select>
                    </div>
                    <div class="lobby-setting">
                        <span>Time For Speaker</span>
                        <select>
                            <option>30s</option>
                            <option>40s</option>
                            <option>50s</option>
                            <option selected>60s</option>
                            <option>70s</option>
                            <option>80s</option>
                            <option>90s</option>
                        </select>
                    </div>
                    @if (!_isReady)
                    {
                        <button id="ready-btn" @onclick="() => Ready(true)">READY</button>
                    }
                    else
                    {
                        <button id="ready-btn" @onclick="() => Ready(false)">UNREADY</button>
                    }
                </fieldset>
            </div>
            <div id="lists">
                <table class="list-table">
                    <thead>
                        <tr>
                            <th>@_lobby.Team1.Name</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var player in _lobby.Team1.Players)
                        {
                            <tr>
                                <td>@player.Name</td>
                            </tr>
                        }
                        @if (_showTeam1JoinBtn)
                        {
                            <tr>
                                <td>
                                    <button class="join-btn" @onclick="()=>ChangeTeam(_lobby.Team1,_lobby.Team2)">JOIN</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
                <table class="list-table">
                    <thead>
                        <tr>
                            <th>PLAYERS</th>
                            @if (_lobby.Admin == _player)
                            {
                                <th>ADMIN</th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var player in _lobby.Players)
                        {
                            <tr>
                                <td>@player.Name</td>
                                @if (_lobby.Admin == _player)
                                {
                                    <td>
                                        <button id="kick-btn">KICK</button>
                                    </td>
                                }
                            </tr>
                        }
                    </tbody>
                </table>
                <table class="list-table">
                    <thead>
                        <tr>
                            <th>@_lobby.Team2.Name</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var player in _lobby.Team2.Players)
                        {
                            <tr>
                                <td>@player.Name</td>
                            </tr>
                        }
                        @if (_showTeam2JoinBtn)
                        {
                            <tr>
                                <td>
                                    <button class="join-btn" @onclick="()=>ChangeTeam(_lobby.Team2,_lobby.Team1)">JOIN</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
    else if (_screens == Screens.ROUND_START)
    {
        <div id="round-start">
            <div id="scoreboard">
                <div class="score">
                    <span>@_lobby.Team1.Name</span>
                    <span>@_lobby.Game.Team1Score</span>
                </div>
                <div class="score">VS</div>
                <div class="score">
                    <span>@_lobby.Team2.Name</span>
                    <span>@_lobby.Game.Team2Score</span>
                </div>
                <div class="number-of-win">
                    Number Of Win: @_lobby.Game.NumberOfWin
                </div>
            </div>
            <div class="next-round-info">
                <div>Next Round Team: @_lobby.Game.CurrentPlayingTeam.Name</div>
                <div>Next Round Narrator Player: @_lobby.Game.CurrentNarratorPlayer.Name</div>
                <div id="round-start-counter">
                    Round starts in @roundStartCounter second
                </div>
            </div>
        </div>

    }
    else if (_screens == Screens.GAME)
    {
        <div id="game">
            <div id="game-header">
                <div id="scoreboard">
                    <div class="score">
                        <span>@_lobby.Team1.Name</span>
                        <span>@_lobby.Game.Team1Score</span>
                    </div>
                    <div class="score">VS</div>
                    <div class="score">
                        <span>@_lobby.Team2.Name</span>
                        <span>@_lobby.Game.Team2Score</span>
                    </div>
                    <div class="number-of-win">
                        Number Of Win: @_lobby.Game.NumberOfWin
                    </div>
                    <div id="counter">Time: @gameCounter</div>
                </div>
            </div>
            <div id="game-body">
                <table class="list-table">
                    <thead>
                        <tr>
                            <th>@_lobby.Team1.Name</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var player in _lobby.Team1.Players)
                        {
                            <tr>
                                <td>@player.Name</td>
                            </tr>
                        }
                    </tbody>
                </table>
                <div id="word-card">
                    <div id="word-card-header">
                        <div id="word">
                            @_lobby.Game.WordCard.Word
                        </div>
                    </div>
                    <div id="word-card-body">
                        <ul>
                            @foreach (var forbiddenWord in @_lobby.Game.WordCard.ForbiddenWords)
                            {
                                <li>@forbiddenWord</li>
                            }
                        </ul>
                    </div>
                    <div id="word-card-controller">
                        <button id="true-btn">TRUE</button>
                        <button id="taboo-btn">TABOO</button>
                        <button id="pass-btn">PASS</button>
                    </div>
                </div>
                <table class="list-table">
                    <thead>
                        <tr>
                            <th>@_lobby.Team2.Name</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var player in _lobby.Team2.Players)
                        {
                            <tr>
                                <td>@player.Name</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
    else // GAME_OVER
    {
        <div id="game-over">
            <div id="scoreboard">
                <div class="score">
                    <span>@_lobby.Team1.Name</span>
                    <span>@_lobby.Game.Team1Score</span>
                </div>
                <div class="score">VS</div>
                <div class="score">
                    <span>@_lobby.Team2.Name</span>
                    <span>@_lobby.Game.Team2Score</span>
                </div>
                <div class="number-of-win">
                    Number Of Win: @_lobby.Game.NumberOfWin
                </div>
            </div>
            <div class="winner-info">
                <div>
                    Winner Team: @_lobby.Game.CurrentPlayingTeam
                </div>
            </div>
            <button @onclick="()=>_screens = Screens.LOBBY">GO TO LOBBY</button>
        </div>
    }
</div>
@code{
    #region Variables
    #region UI
    private enum Screens { LOGIN = 0, LOBBY, GAME, GAMEOVER, ROUND_START }
    private Screens _screens = Screens.LOGIN;
    private bool _showTeam1JoinBtn = true;
    private bool _showTeam2JoinBtn = true;
    private bool _isReady = false;
    #endregion
    private Player _player = new Player();
    private Lobby _lobby;
    private string _lobbyID;
    #endregion

    #region Initialize
    private string _hubUrl;
    private HubConnection _hubConnection;

    protected override async Task OnInitializedAsync()
    {
        string baseUrl = navigationManager.BaseUri;
        _hubUrl = baseUrl.TrimEnd('/') + GameHub.url;
        _hubConnection = new HubConnectionBuilder()
            .WithUrl(_hubUrl)
            .Build();

        _hubConnection.On<string>("GetPlayerID", (string id) => _player.ID = id);
        _hubConnection.On("Refresh", () => StateHasChanged());
        _hubConnection.On("RoundStart", () => { _screens = Screens.ROUND_START; StateHasChanged(); SetRoundStartCounter(); });
        _hubConnection.On("StartGame", () => { _screens = Screens.GAME; StateHasChanged(); SetGameCounterElapsed(); });
        await _hubConnection.StartAsync();
    }
    #endregion

    #region LOGIN LOBBY
    private async Task Play()
    {
        if (_lobbyID == null) await CreateLobby();
        else await JoinLobby();
    }
    private async Task CreateLobby()
    {
        _lobby = GameDatabase.Lobbies.CreateLobby(_player);
        _screens = Screens.LOBBY;

        await _hubConnection.InvokeAsync("CreateLobby", _lobby.Admin.ID, _lobby.ID);
    }
    private async Task JoinLobby()
    {
        _lobby = GameDatabase.Lobbies.JoinLobby(_player, _lobbyID);
        _screens = Screens.LOBBY;

        await _hubConnection.InvokeAsync("JoinLobby", _player.ID, _lobbyID);
    }
    #endregion

    #region LOBBY
    private async Task ChangeTeam(Team newTeam, Team oldTeam)
    {
        _player.ChangeTeam(newTeam, oldTeam);
        if (newTeam == _lobby.Team1) { _showTeam1JoinBtn = false; _showTeam2JoinBtn = true; }
        else { _showTeam2JoinBtn = false; _showTeam1JoinBtn = true; }
        await _hubConnection.InvokeAsync("ChangeTeam", _lobby.ID);
    }
    private async Task Ready(bool isReady)
    {
        if (isReady)
        {
            _lobby.ReadyPlayers.Add(_player);
            if (_lobby.CheckArePlayersReady())
            {
                _lobby.ClearReadyPlayers();
                await RoundStart();
            }
        }
        else _lobby.ReadyPlayers.Remove(_player);

        _isReady = isReady;
        StateHasChanged();
    }
    private async Task RoundStart()
    {
        _lobby.Game = new Models.Game(_lobby, 10, 5, 3, 3);
        _lobby.Game.GenerateGame();
        await _hubConnection.InvokeAsync("RoundStart", _lobby.ID);
    }
    private async Task StartGame() => await _hubConnection.InvokeAsync("StartGame", _lobby.ID);
    #endregion

    Timer timer;
    int roundStartCounter = 5;
    private void SetRoundStartCounter()
    {
        timer = new Timer(1000);
        timer.Elapsed += RoundStartCounterElapsed;
        timer.Enabled = true;
        timer.Start();
    }

    private void RoundStartCounterElapsed(object obj, ElapsedEventArgs elapsedEventArgs)
    {
        if (roundStartCounter <= 1)
        {
            timer.Dispose();
            InvokeAsync(StartGame);
        }
        roundStartCounter--;
        InvokeAsync(StateHasChanged);
    }

    int gameCounter = 8;
    private void SetGameCounterElapsed()
    {
        timer = new Timer(1000);
        timer.Elapsed += GameCounterElapsed;
        timer.Enabled = true;
        timer.Start();
    }

    private void GameCounterElapsed(object obj, ElapsedEventArgs elapsedEventArgs)
    {
        if (gameCounter <= 1)
            timer.Dispose();

        gameCounter--;
        InvokeAsync(StateHasChanged);
    }
}



